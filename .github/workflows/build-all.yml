name: Build All Platforms

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'

jobs:
  # Call the Android build workflow
  build-android:
    name: Build Android
    uses: ./.github/workflows/build-android.yml

  # Call the iOS build workflow
  build-ios:
    name: Build iOS
    uses: ./.github/workflows/build-ios.yml

  # Validate all builds completed successfully
  validate-builds:
    name: Validate All Builds
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download Android artifacts
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages
          path: ./artifacts/android

      - name: Download iOS artifacts
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts/ios

      - name: List all packages
        run: |
          echo "=== Android Packages ==="
          ls -lh ./artifacts/android/
          echo ""
          echo "=== iOS Packages ==="
          ls -lh ./artifacts/ios/
          echo ""
          echo "=== Package Count ==="
          echo "Android: $(ls -1 ./artifacts/android/*.nupkg 2>/dev/null | wc -l) packages"
          echo "iOS: $(ls -1 ./artifacts/ios/*.nupkg 2>/dev/null | wc -l) packages"

      - name: Verify package versions
        run: |
          echo "Verifying all packages have consistent versioning..."
          # Extract versions from package names
          find ./artifacts -name "*.nupkg" -exec basename {} \; | sort

      - name: Upload combined artifacts
        uses: actions/upload-artifact@v6
        with:
          name: all-nuget-packages
          path: ./artifacts/**/*.nupkg
          retention-days: 30
