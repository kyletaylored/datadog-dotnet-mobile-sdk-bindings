name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.26.1, 2.27.0)'
        required: true
        type: string
      platform:
        description: 'Platform to publish'
        required: true
        type: choice
        options:
          - android
          - ios
          - both
      publish_to_nuget:
        description: 'Publish to NuGet.org (uncheck for dry-run)'
        required: true
        type: boolean
        default: false
      is_prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false

env:
  NUGET_SOURCE: 'https://api.nuget.org/v3/index.json'

jobs:
  # Build packages using prepare-release workflow
  prepare-packages:
    name: Prepare Release Packages
    uses: ./.github/workflows/prepare-release.yml
    with:
      version: ${{ github.event.inputs.version }}
      platform: ${{ github.event.inputs.platform }}
    secrets: inherit

  # Validate packages before publishing
  validate-packages:
    name: Validate Packages
    runs-on: ubuntu-latest
    needs: prepare-packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./all-artifacts

      - name: List all packages
        run: |
          echo "=== All NuGet Packages ==="
          find ./all-artifacts -name "*.nupkg" -exec basename {} \; | sort
          echo ""
          echo "=== Package Count ==="
          echo "Total: $(find ./all-artifacts -name "*.nupkg" | wc -l) packages"

      - name: Verify package versions match
        run: |
          echo "Verifying all packages contain version ${{ github.event.inputs.version }}..."

          MISMATCHED=0
          for package in $(find ./all-artifacts -name "*.nupkg"); do
            pkg_name=$(basename "$package")
            if [[ "$pkg_name" != *"${{ github.event.inputs.version }}"* ]]; then
              echo "âŒ Version mismatch: $pkg_name"
              MISMATCHED=$((MISMATCHED + 1))
            else
              echo "âœ… $pkg_name"
            fi
          done

          if [ $MISMATCHED -gt 0 ]; then
            echo "âŒ Found $MISMATCHED packages with version mismatches!"
            exit 1
          fi

          echo "âœ… All packages have correct version ${{ github.event.inputs.version }}"

      - name: Validate package metadata
        run: |
          # Check for required metadata in packages
          echo "Validating package metadata..."

          for package in $(find ./all-artifacts -name "*.nupkg"); do
            pkg_name=$(basename "$package")
            echo "Inspecting $pkg_name..."

            # Extract and check nuspec
            unzip -q "$package" -d temp-pkg

            if [ ! -f temp-pkg/*.nuspec ]; then
              echo "âŒ No .nuspec found in $pkg_name"
              exit 1
            fi

            # Check for license file
            if [ ! -f temp-pkg/LICENSE ]; then
              echo "âš ï¸  Warning: No LICENSE file in $pkg_name"
            fi

            rm -rf temp-pkg
          done

          echo "âœ… Package metadata validation complete"

  # Publish to NuGet.org
  publish-to-nuget:
    name: Publish to NuGet.org
    runs-on: ubuntu-latest
    needs: validate-packages
    if: github.event.inputs.publish_to_nuget == 'true'
    environment: production

    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./all-artifacts

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'

      - name: Publish packages to NuGet.org
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          echo "Publishing packages to NuGet.org..."

          SUCCESS=0
          FAILED=0

          for package in $(find ./all-artifacts -name "*.nupkg"); do
            pkg_name=$(basename "$package")
            echo "Publishing $pkg_name..."

            if dotnet nuget push "$package" \
              --api-key "$NUGET_API_KEY" \
              --source "${{ env.NUGET_SOURCE }}" \
              --skip-duplicate; then
              echo "âœ… Published: $pkg_name"
              SUCCESS=$((SUCCESS + 1))
            else
              echo "âŒ Failed: $pkg_name"
              FAILED=$((FAILED + 1))
            fi
          done

          echo ""
          echo "=== Publish Summary ==="
          echo "âœ… Successful: $SUCCESS"
          echo "âŒ Failed: $FAILED"

          if [ $FAILED -gt 0 ]; then
            echo "âŒ Some packages failed to publish!"
            exit 1
          fi

          echo "âœ… All packages published successfully!"

  # Create GitHub Release
  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate-packages, publish-to-nuget]
    if: always() && needs.validate-packages.result == 'success'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./all-artifacts

      - name: Prepare release assets
        run: |
          mkdir -p ./release-assets
          find ./all-artifacts -name "*.nupkg" -exec cp {} ./release-assets/ \;

          echo "=== Release Assets ==="
          ls -lh ./release-assets/
          echo ""
          echo "Total packages: $(ls -1 ./release-assets/*.nupkg | wc -l)"

      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << 'EOF'
          # Datadog .NET Mobile SDK Bindings v${{ github.event.inputs.version }}

          This release provides .NET bindings for Datadog Mobile SDKs version ${{ github.event.inputs.version }}.

          ## ðŸ“¦ Platform Support

          ${{ github.event.inputs.platform == 'android' && '- âœ… Android' || '' }}
          ${{ github.event.inputs.platform == 'ios' && '- âœ… iOS' || '' }}
          ${{ github.event.inputs.platform == 'both' && '- âœ… Android\n- âœ… iOS' || '' }}

          ## ðŸ“¥ Installation

          ### Android Packages

          ```xml
          <PackageReference Include="Bcr.Datadog.Android.Core" Version="${{ github.event.inputs.version }}" />
          ```

          ### iOS Packages

          ```xml
          <PackageReference Include="Bcr.Datadog.iOS.ObjC" Version="${{ github.event.inputs.version }}" />
          ```

          ## ðŸŽ¯ Multi-Framework Support

          iOS packages support:
          - `net8.0-ios` - .NET 8 projects
          - `net9.0-ios` - .NET 9 projects
          - `net10.0-ios` - .NET 10 projects

          All frameworks target iOS 17.0+

          ## ðŸ“š Documentation

          - [Getting Started Guide](https://github.com/${{ github.repository }}/blob/main/GETTING_STARTED.md)
          - [Building & Versioning Guide](https://github.com/${{ github.repository }}/blob/main/BUILDING_AND_VERSIONING.md)
          - [Official Datadog Documentation](https://docs.datadoghq.com/)

          ## ðŸ”— Native SDK Versions

          This release binds to:
          - [dd-sdk-android v${{ github.event.inputs.version }}](https://github.com/DataDog/dd-sdk-android/releases/tag/${{ github.event.inputs.version }})
          - [dd-sdk-ios v${{ github.event.inputs.version }}](https://github.com/DataDog/dd-sdk-ios/releases/tag/${{ github.event.inputs.version }})

          ## ðŸ“¦ Included Packages

          $(find ./release-assets -name "*.nupkg" -exec basename {} \; | sort | sed 's/^/- /')

          ## âš ï¸ Important Notes

          - iOS packages now support multiple .NET versions (8, 9, 10) in a single package
          - Android requires .NET 10 for 16KB page size support
          - All iOS frameworks target iOS 17.0 minimum

          ## ðŸ’¬ Support

          For SDK usage and features, refer to the [Official Datadog Documentation](https://docs.datadoghq.com/).

          For binding-specific issues, please [open an issue](https://github.com/${{ github.repository }}/issues).
          EOF

          cat release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: v${{ github.event.inputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.is_prerelease }}
          files: ./release-assets/*.nupkg
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Notify completion
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [create-github-release, publish-to-nuget]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "# ðŸŽ‰ Release v${{ github.event.inputs.version }} Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Platform: ${{ github.event.inputs.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Published to NuGet: ${{ github.event.inputs.publish_to_nuget }}" >> $GITHUB_STEP_SUMMARY
          echo "- Pre-release: ${{ github.event.inputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ github.event.inputs.publish_to_nuget }}" == "true" ]; then
            echo "## ðŸ“¦ Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. âœ… Packages are now available on NuGet.org" >> $GITHUB_STEP_SUMMARY
            echo "2. âœ… GitHub release has been created" >> $GITHUB_STEP_SUMMARY
            echo "3. Update CHANGELOG.md with release notes" >> $GITHUB_STEP_SUMMARY
            echo "4. Announce release to users" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ“¦ Dry Run Complete" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This was a dry run. To publish:" >> $GITHUB_STEP_SUMMARY
            echo "1. Review the generated packages" >> $GITHUB_STEP_SUMMARY
            echo "2. Test packages locally" >> $GITHUB_STEP_SUMMARY
            echo "3. Re-run workflow with 'Publish to NuGet.org' checked" >> $GITHUB_STEP_SUMMARY
          fi
