name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.21.0-pre.1)'
        required: true
        type: string
      platform:
        description: 'Platform to release'
        required: true
        type: choice
        options:
          - android
          - ios
          - both

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  prepare-android-release:
    name: Prepare Android Release ${{ github.event.inputs.version }}
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: '17'

      # Build with SDK 9 for net9.0-android
      - name: Setup .NET SDK 9
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-9
        with:
          dotnet-version: 9.0.x

      - name: Create temporary global.json for SDK 9
        run: echo '{"sdk":{"version":"${{ steps.setup-dotnet-9.outputs.dotnet-version }}","rollForward":"latestPatch"}}' > ./global.json

      - name: Install Android workload (SDK 9)
        run: dotnet workload install android

      - name: Restore dependencies (SDK 9)
        run: dotnet restore src/Android/AndroidDatadogBindings.sln

      - name: Build Release (net9.0-android)
        run: dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore --verbosity minimal

      - name: Pack NuGet packages (net9.0-android)
        run: dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./release-packages-net9 2>&1 | grep -v "prerelease dependency" || true

      # Build with SDK 10 for net10.0-android
      - name: Remove global.json to allow SDK 10
        run: rm -f global.json

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install Android workload (SDK 10)
        run: dotnet workload install android

      - name: Restore dependencies (SDK 10)
        run: dotnet restore src/Android/AndroidDatadogBindings.sln

      - name: Build Release (net10.0-android)
        run: dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore --verbosity minimal

      - name: Pack NuGet packages (net10.0-android)
        run: dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./release-packages-net10 2>&1 | grep -v "prerelease dependency" || true

      # Combine both builds into unified packages
      - name: Combine packages for all target frameworks
        run: |
          mkdir -p ./release-packages
          mkdir -p ./temp-extract

          # Process each package
          for net9_pkg in ./release-packages-net9/*.nupkg; do
            pkg_name=$(basename "$net9_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+.*\.nupkg$//')
            version=$(basename "$net9_pkg" | sed -n 's/.*\.\([0-9]\+\.[0-9]\+\.[0-9]\+[^.]*\)\.nupkg$/\1/p')
            net10_pkg="./release-packages-net10/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            if [ -f "$net10_pkg" ]; then
              # Extract both packages
              unzip -q "$net9_pkg" -d "./temp-extract/net9"
              unzip -q "$net10_pkg" -d "./temp-extract/net10"

              # Copy net10.0-android lib to net9 package structure
              if [ -d "./temp-extract/net10/lib/net10.0-android" ]; then
                cp -r "./temp-extract/net10/lib/net10.0-android" "./temp-extract/net9/lib/"
              fi

              # Repackage the combined content
              (cd "./temp-extract/net9" && zip -q -r "../../release-packages/${pkg_name}.${version}.nupkg" *)

              # Clean up temp directory
              rm -rf "./temp-extract/net9" "./temp-extract/net10"

              echo "Created combined package: ${pkg_name}.${version}.nupkg"
            else
              echo "Warning: Missing net10 package, using net9 only"
              cp "$net9_pkg" "./release-packages/"
            fi
          done

      - name: List packages
        run: |
          echo "=== Android Release Packages ==="
          ls -lh ./release-packages/
          echo ""
          echo "Package count: $(ls -1 ./release-packages/*.nupkg 2>/dev/null | wc -l)"

      - name: Verify package versions
        run: |
          echo "Verifying all packages contain version ${{ github.event.inputs.version }}..."

          MISMATCHED=0
          for package in ./release-packages/*.nupkg; do
            if [[ $(basename "$package") != *"${{ github.event.inputs.version }}"* ]]; then
              echo "âŒ Version mismatch in: $(basename "$package")"
              MISMATCHED=$((MISMATCHED + 1))
            else
              echo "âœ… $(basename "$package")"
            fi
          done

          if [ $MISMATCHED -gt 0 ]; then
            echo "âŒ Found $MISMATCHED packages with version mismatches!"
            exit 1
          fi

          echo "âœ… All packages have correct version"

      - name: Upload release packages
        uses: actions/upload-artifact@v6
        with:
          name: release-packages-android
          path: ./release-packages/*.nupkg
          retention-days: 90

      - name: Generate release notes
        run: |
          cat > release-notes-android.md << 'EOF'
          # Release ${{ github.event.inputs.version }} - Android

          ## Packages

          $(ls -1 ./release-packages/*.nupkg | xargs -n1 basename)

          ## Installation

          \`\`\`bash
          # Install packages
          $(for pkg in ./release-packages/*.nupkg; do
            echo "dotnet add package $(basename "$pkg" | sed 's/\.[0-9].*//')"
          done)
          \`\`\`

          ## Checksums

          $(cd release-packages && sha256sum *.nupkg)
          EOF

          cat release-notes-android.md

      - name: Upload release notes
        uses: actions/upload-artifact@v6
        with:
          name: release-notes-android
          path: release-notes-android.md
          retention-days: 90

  prepare-ios-release:
    name: Prepare iOS Release ${{ github.event.inputs.version }}
    runs-on: macos-15
    if: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Initialize and verify submodules
        run: |
          echo "Initializing submodules..."
          git submodule update --init --recursive
          echo "Verifying dd-sdk-ios exists..."
          ls -la dd-sdk-ios/

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Install Carthage
        run: brew install carthage

      - name: Build XCFrameworks
        run: ./src/iOS/buildxcframework.sh
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-8
        with:
          dotnet-version: 8.0.x

      - name: Create temporary global.json for SDK 8
        run: echo '{"sdk":{"version":"${{ steps.setup-dotnet-8.outputs.dotnet-version }}","rollForward":"latestPatch"}}' > ./global.json

      - name: Install iOS workload (SDK 8)
        run: dotnet workload install ios

      - name: Restore dependencies (SDK 8)
        run: dotnet restore src/iOS/iOSBindings.sln

      - name: Build Release (net8.0-ios)
        run: dotnet build src/iOS/iOSBindings.sln --configuration Release --no-restore

      - name: Pack NuGet packages (net8.0-ios)
        run: dotnet pack src/iOS/iOSBindings.sln --configuration Release --no-build --output ./release-packages-net8

      - name: Remove global.json to allow SDK 9+
        run: rm -f global.json

      - name: Setup .NET SDK 9 and 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Install iOS workload (SDK 9+)
        run: dotnet workload install ios

      - name: Restore dependencies (SDK 9+)
        run: dotnet restore src/iOS/iOSBindings.sln

      - name: Build Release (net9.0-ios, net10.0-ios)
        run: dotnet build src/iOS/iOSBindings.sln --configuration Release --no-restore

      - name: Pack NuGet packages (net9.0-ios, net10.0-ios)
        run: dotnet pack src/iOS/iOSBindings.sln --configuration Release --no-build --output ./release-packages-net9plus

      - name: Combine packages for all target frameworks
        run: |
          mkdir -p ./release-packages
          mkdir -p ./temp-extract

          # Process each package
          for net8_pkg in ./release-packages-net8/*.nupkg; do
            pkg_name=$(basename "$net8_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//')
            version=$(basename "$net8_pkg" | grep -oP '\d+\.\d+\.\d+(?=\.nupkg)')
            net9plus_pkg="./release-packages-net9plus/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            if [ -f "$net9plus_pkg" ]; then
              # Extract both packages
              unzip -q "$net8_pkg" -d "./temp-extract/net8"
              unzip -q "$net9plus_pkg" -d "./temp-extract/net9plus"

              # Copy net9.0-ios and net10.0-ios libs to net8 package structure
              if [ -d "./temp-extract/net9plus/lib/net9.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net9.0-ios" "./temp-extract/net8/lib/"
              fi
              if [ -d "./temp-extract/net9plus/lib/net10.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net10.0-ios" "./temp-extract/net8/lib/"
              fi

              # Repackage the combined content
              cd "./temp-extract/net8"
              zip -q -r "../../release-packages/${pkg_name}.${version}.nupkg" *
              cd ../..

              # Clean up temp directory
              rm -rf "./temp-extract/net8" "./temp-extract/net9plus"

              echo "Created combined package: ${pkg_name}.${version}.nupkg"
            else
              echo "Warning: No matching net9+ package found for $pkg_name"
              cp "$net8_pkg" "./release-packages/"
            fi
          done

      - name: List packages
        run: |
          echo "=== iOS Release Packages ==="
          ls -lh ./release-packages/
          echo ""
          echo "Package count: $(ls -1 ./release-packages/*.nupkg 2>/dev/null | wc -l)"

      - name: Verify package versions
        run: |
          echo "Verifying all packages contain version ${{ github.event.inputs.version }}..."

          MISMATCHED=0
          for package in ./release-packages/*.nupkg; do
            if [[ $(basename "$package") != *"${{ github.event.inputs.version }}"* ]]; then
              echo "âŒ Version mismatch in: $(basename "$package")"
              MISMATCHED=$((MISMATCHED + 1))
            else
              echo "âœ… $(basename "$package")"
            fi
          done

          if [ $MISMATCHED -gt 0 ]; then
            echo "âŒ Found $MISMATCHED packages with version mismatches!"
            exit 1
          fi

          echo "âœ… All packages have correct version"

      - name: Upload release packages
        uses: actions/upload-artifact@v6
        with:
          name: release-packages-ios
          path: ./release-packages/*.nupkg
          retention-days: 90

      - name: Generate release notes
        run: |
          cat > release-notes-ios.md << 'EOF'
          # Release ${{ github.event.inputs.version }} - iOS

          ## Packages

          $(ls -1 ./release-packages/*.nupkg | xargs -n1 basename)

          ## Installation

          \`\`\`bash
          # Install packages
          $(for pkg in ./release-packages/*.nupkg; do
            echo "dotnet add package $(basename "$pkg" | sed 's/\.[0-9].*//')"
          done)
          \`\`\`

          ## Checksums

          $(cd release-packages && sha256sum *.nupkg)
          EOF

          cat release-notes-ios.md

      - name: Upload release notes
        uses: actions/upload-artifact@v6
        with:
          name: release-notes-ios
          path: release-notes-ios.md
          retention-days: 90

  create-release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: [prepare-android-release, prepare-ios-release]
    if: always()  # Run even if one platform was skipped

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./all-artifacts

      - name: Create combined release notes
        run: |
          echo "# Release ${{ github.event.inputs.version }}" > RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## All Packages" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md

          find ./all-artifacts -name "*.nupkg" -exec basename {} \; | sort >> RELEASE_SUMMARY.md

          echo "" >> RELEASE_SUMMARY.md
          echo "## Platform Notes" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md

          find ./all-artifacts -name "release-notes-*.md" -exec cat {} \; >> RELEASE_SUMMARY.md

          cat RELEASE_SUMMARY.md

      - name: Upload release summary
        uses: actions/upload-artifact@v6
        with:
          name: release-summary
          path: RELEASE_SUMMARY.md
          retention-days: 90

      - name: Comment on workflow
        run: |
          echo "âœ… Release ${{ github.event.inputs.version }} prepared successfully!"
          echo ""
          echo "ðŸ“¦ Next steps:"
          echo "1. Download artifacts and verify packages"
          echo "2. Test packages locally"
          echo "3. Push to NuGet: dotnet nuget push <package>.nupkg --api-key <key> --source https://api.nuget.org/v3/index.json"
          echo "4. Create GitHub release with artifacts"
          echo "5. Update CHANGELOG.md"
