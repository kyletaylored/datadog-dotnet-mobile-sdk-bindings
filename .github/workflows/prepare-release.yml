name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 2.21.0-pre.1)'
        required: true
        type: string
      platform:
        description: 'Platform to release'
        required: true
        type: choice
        options:
          - android
          - ios
          - both

env:
  DOTNET_VERSION: '10.0.x'

jobs:
  prepare-release:
    name: Prepare Release ${{ github.event.inputs.version }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: android
            enabled: ${{ github.event.inputs.platform == 'android' || github.event.inputs.platform == 'both' }}
          - os: macos-15
            platform: ios
            enabled: ${{ github.event.inputs.platform == 'ios' || github.event.inputs.platform == 'both' }}

    if: ${{ matrix.enabled }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
            10.0.x

      - name: Setup Java (Android only)
        if: matrix.platform == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'

      - name: Select Xcode (iOS only)
        if: matrix.platform == 'ios'
        run: sudo xcode-select -s /Applications/Xcode_16.1.app

      - name: Install workloads
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            dotnet workload install android
          else
            dotnet workload install ios
          fi

      - name: Restore dependencies
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            dotnet restore src/Android/AndroidDatadogBindings.sln
          else
            dotnet restore src/iOS/iOSBindings.sln
          fi

      - name: Build Release
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore
          else
            dotnet build src/iOS/iOSBindings.sln --configuration Release --no-restore
          fi

      - name: Pack NuGet packages
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./release-packages
          else
            dotnet pack src/iOS/iOSBindings.sln --configuration Release --no-build --output ./release-packages
          fi

      - name: List packages
        run: |
          echo "=== Release Packages for ${{ matrix.platform }} ==="
          ls -lh ./release-packages/
          echo ""
          echo "Package count: $(ls -1 ./release-packages/*.nupkg 2>/dev/null | wc -l)"

      - name: Verify package versions
        run: |
          echo "Verifying all packages contain version ${{ github.event.inputs.version }}..."

          MISMATCHED=0
          for package in ./release-packages/*.nupkg; do
            if [[ $(basename "$package") != *"${{ github.event.inputs.version }}"* ]]; then
              echo "âŒ Version mismatch in: $(basename "$package")"
              MISMATCHED=$((MISMATCHED + 1))
            else
              echo "âœ… $(basename "$package")"
            fi
          done

          if [ $MISMATCHED -gt 0 ]; then
            echo "âŒ Found $MISMATCHED packages with version mismatches!"
            exit 1
          fi

          echo "âœ… All packages have correct version"

      - name: Upload release packages
        uses: actions/upload-artifact@v4
        with:
          name: release-packages-${{ matrix.platform }}
          path: ./release-packages/*.nupkg
          retention-days: 90

      - name: Generate release notes
        run: |
          cat > release-notes-${{ matrix.platform }}.md << 'EOF'
          # Release ${{ github.event.inputs.version }} - ${{ matrix.platform }}

          ## Packages

          $(ls -1 ./release-packages/*.nupkg | xargs -n1 basename)

          ## Installation

          \`\`\`bash
          # Install packages
          $(for pkg in ./release-packages/*.nupkg; do
            echo "dotnet add package $(basename "$pkg" | sed 's/\.[0-9].*//')"
          done)
          \`\`\`

          ## Checksums

          $(cd release-packages && sha256sum *.nupkg)
          EOF

          cat release-notes-${{ matrix.platform }}.md

      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ matrix.platform }}
          path: release-notes-${{ matrix.platform }}.md
          retention-days: 90

  create-release-summary:
    name: Create Release Summary
    runs-on: ubuntu-latest
    needs: prepare-release

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts

      - name: Create combined release notes
        run: |
          echo "# Release ${{ github.event.inputs.version }}" > RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md
          echo "## All Packages" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md

          find ./all-artifacts -name "*.nupkg" -exec basename {} \; | sort >> RELEASE_SUMMARY.md

          echo "" >> RELEASE_SUMMARY.md
          echo "## Platform Notes" >> RELEASE_SUMMARY.md
          echo "" >> RELEASE_SUMMARY.md

          find ./all-artifacts -name "release-notes-*.md" -exec cat {} \; >> RELEASE_SUMMARY.md

          cat RELEASE_SUMMARY.md

      - name: Upload release summary
        uses: actions/upload-artifact@v4
        with:
          name: release-summary
          path: RELEASE_SUMMARY.md
          retention-days: 90

      - name: Comment on workflow
        run: |
          echo "âœ… Release ${{ github.event.inputs.version }} prepared successfully!"
          echo ""
          echo "ðŸ“¦ Next steps:"
          echo "1. Download artifacts and verify packages"
          echo "2. Test packages locally"
          echo "3. Push to NuGet: dotnet nuget push <package>.nupkg --api-key <key> --source https://api.nuget.org/v3/index.json"
          echo "4. Create GitHub release with artifacts"
          echo "5. Update CHANGELOG.md"
