name: Build iOS Bindings

on:
  workflow_call:  # Allow this workflow to be called by other workflows
  workflow_dispatch:  # Allow manual triggering

env:
  XCODE_VERSION: '16.1'

jobs:
  # Build with .NET SDK 8 for net8.0-ios support
  build-ios-net8:
    name: Build iOS Bindings (net8.0-ios)
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 8.0.x

      - name: Install .NET MAUI iOS workload for SDK 8
        run: dotnet workload install ios

      - name: Restore dependencies (SDK 8)
        run: dotnet restore src/iOS/iOSBindings.sln

      - name: Build iOS bindings (net8.0-ios)
        run: dotnet build src/iOS/iOSBindings.sln --configuration Release --no-restore

      - name: Package NuGet packages (net8.0-ios)
        run: dotnet pack src/iOS/iOSBindings.sln --configuration Release --no-build --output ./artifacts-net8

      - name: Upload net8.0-ios artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net8
          path: ./artifacts-net8/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-build-logs-net8
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET SDK 9+ for net9.0-ios and net10.0-ios support
  build-ios-net9plus:
    name: Build iOS Bindings (net9.0-ios, net10.0-ios)
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Remove global.json to allow SDK 9+
        run: rm -f global.json

      - name: Setup .NET SDK 9 and 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Install .NET MAUI iOS workload for SDK 9+
        run: dotnet workload install ios

      - name: Restore dependencies (SDK 9+)
        run: dotnet restore src/iOS/iOSBindings.sln

      - name: Build iOS bindings (net9.0-ios, net10.0-ios)
        run: dotnet build src/iOS/iOSBindings.sln --configuration Release --no-restore

      - name: Package NuGet packages (net9.0-ios, net10.0-ios)
        run: dotnet pack src/iOS/iOSBindings.sln --configuration Release --no-build --output ./artifacts-net9plus

      - name: Upload net9.0-ios and net10.0-ios artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net9plus
          path: ./artifacts-net9plus/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-build-logs-net9plus
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Combine the net8 and net9+ packages into unified NuGet packages
  combine-ios-packages:
    name: Combine iOS Packages
    runs-on: ubuntu-latest
    needs: [build-ios-net8, build-ios-net9plus]

    steps:
      - name: Download net8.0-ios packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net8
          path: ./artifacts-net8

      - name: Download net9.0-ios and net10.0-ios packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net9plus
          path: ./artifacts-net9plus

      - name: Install NuGet CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y nuget

      - name: Combine packages for all target frameworks
        run: |
          mkdir -p ./artifacts-combined
          mkdir -p ./temp-extract

          # Process each package
          for net8_pkg in ./artifacts-net8/*.nupkg; do
            pkg_name=$(basename "$net8_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//')
            version=$(basename "$net8_pkg" | grep -oP '\d+\.\d+\.\d+(?=\.nupkg)')
            net9plus_pkg="./artifacts-net9plus/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            if [ -f "$net9plus_pkg" ]; then
              # Extract both packages
              unzip -q "$net8_pkg" -d "./temp-extract/net8"
              unzip -q "$net9plus_pkg" -d "./temp-extract/net9plus"

              # Copy net9.0-ios and net10.0-ios libs to net8 package structure
              if [ -d "./temp-extract/net9plus/lib/net9.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net9.0-ios" "./temp-extract/net8/lib/"
              fi
              if [ -d "./temp-extract/net9plus/lib/net10.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net10.0-ios" "./temp-extract/net8/lib/"
              fi

              # Repackage the combined content
              cd "./temp-extract/net8"
              zip -q -r "../../artifacts-combined/${pkg_name}.${version}.nupkg" *
              cd ../..

              # Clean up temp directory
              rm -rf "./temp-extract/net8" "./temp-extract/net9plus"

              echo "Created combined package: ${pkg_name}.${version}.nupkg"
            else
              echo "Warning: No matching net9+ package found for $pkg_name"
              # Fall back to net8 package only
              cp "$net8_pkg" "./artifacts-combined/"
            fi
          done

      - name: List combined packages
        run: ls -lh ./artifacts-combined/

      - name: Upload combined NuGet packages
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages
          path: ./artifacts-combined/*.nupkg
          retention-days: 7

  build-ios-test:
    name: Build iOS Test App
    runs-on: macos-15
    needs: combine-ios-packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Install .NET MAUI workload
        run: dotnet workload install ios

      - name: Download NuGet packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts

      - name: Add local NuGet source
        run: dotnet nuget add source ./artifacts --name local

      - name: Restore test app dependencies
        run: dotnet restore src/iOS/T/Test.sln

      - name: Build test app
        run: dotnet build src/iOS/T/Test.sln --configuration Release --no-restore -p:BuildIpa=true

      - name: Upload test app
        uses: actions/upload-artifact@v6
        with:
          name: ios-test-app
          path: |
            src/iOS/T/bin/Release/**/*.app
            src/iOS/T/bin/Release/**/*.ipa
          retention-days: 7
