name: Build iOS Bindings

on:
  workflow_call:  # Allow this workflow to be called by other workflows
  workflow_dispatch:  # Allow manual triggering

env:
  XCODE_VERSION: '26.0' # Must be one of https://github.com/actions/runner-images/blob/main/images/macos/macos-15-Readme.md#xcode

jobs:
  # Build XCFrameworks once and share across all builds
  build-xcframeworks:
    name: XCFrameworks
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Initialize and verify submodules
        run: |
          echo "Initializing submodules..."
          git submodule update --init --recursive
          echo "Checking submodule status..."
          git submodule status
          echo "Verifying dd-sdk-ios exists..."
          ls -la dd-sdk-ios/
          echo "Verifying Cartfile exists..."
          ls -la dd-sdk-ios/Cartfile

      - name: Get dd-sdk-ios commit hash
        id: sdk-version
        run: echo "commit=$(git -C dd-sdk-ios rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache XCFrameworks
        id: cache-xcframeworks
        uses: actions/cache@v5
        with:
          path: src/iOS/Bindings/Libs/*.xcframework
          key: ${{ runner.os }}-xcframeworks-${{ steps.sdk-version.outputs.commit }}
          restore-keys: |
            ${{ runner.os }}-xcframeworks-

      - name: Select Xcode version
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Show Xcode version
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: xcodebuild -version

      - name: Install iOS platform
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: |
          xcodebuild -version
          xcrun simctl list > /dev/null
          xcodebuild -downloadPlatform iOS

      - name: Cache Carthage dependencies
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        uses: actions/cache@v5
        with:
          path: |
            dd-sdk-ios/Carthage
            ~/Library/Caches/org.carthage.CarthageKit
          key: ${{ runner.os }}-carthage-${{ hashFiles('dd-sdk-ios/Cartfile.resolved') }}
          restore-keys: |
            ${{ runner.os }}-carthage-

      - name: Build XCFrameworks
        if: steps.cache-xcframeworks.outputs.cache-hit != 'true'
        run: ./src/iOS/buildxcframework.sh
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload XCFrameworks
        uses: actions/upload-artifact@v6
        with:
          name: ios-xcframeworks
          path: src/iOS/Bindings/Libs/*.xcframework
          retention-days: 1

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: xcframework-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET SDK 8 for net8.0-ios support
  build-ios-net8:
    needs: build-xcframeworks
    name: net8.0-ios
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download XCFrameworks
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: src/iOS/Bindings/Libs

      - name: Verify XCFrameworks
        run: ls -la src/iOS/Bindings/Libs/

      - name: Setup .NET SDK 8
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-8
        with:
          dotnet-version: 8.0.x

      - name: Create temporary global.json for SDK 8
        run: echo '{"sdk":{"version":"${{ steps.setup-dotnet-8.outputs.dotnet-version }}","rollForward":"latestPatch"}}' > ./global.json

      - name: Verify SDK version
        run: dotnet --version

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/Library/Caches/NuGet
          key: ${{ runner.os }}-dotnet-workload-ios-${{ steps.setup-dotnet-8.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-ios-

      - name: Install .NET MAUI iOS workload for SDK 8
        run: dotnet workload install ios

      - name: Get dd-sdk-ios commit hash for cache
        id: sdk-version-net8
        run: echo "commit=$(git -C dd-sdk-ios rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache NuGet packages (net8.0-ios)
        id: cache-nuget-net8
        uses: actions/cache@v5
        with:
          path: ./artifacts-net8/*.nupkg
          key: ${{ runner.os }}-ios-net8-packages-${{ steps.sdk-version-net8.outputs.commit }}-${{ hashFiles('src/iOS/Bindings/**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-net8-packages-${{ steps.sdk-version-net8.outputs.commit }}-

      - name: Restore dependencies (SDK 8)
        if: steps.cache-nuget-net8.outputs.cache-hit != 'true'
        run: dotnet restore src/iOS/iOSDatadogBindings.sln

      - name: Build iOS bindings (net8.0-ios)
        if: steps.cache-nuget-net8.outputs.cache-hit != 'true'
        run: dotnet build src/iOS/iOSDatadogBindings.sln --configuration Release --no-restore

      - name: Package NuGet packages (net8.0-ios)
        if: steps.cache-nuget-net8.outputs.cache-hit != 'true'
        run: dotnet pack src/iOS/iOSDatadogBindings.sln --configuration Release --no-build --output ./artifacts-net8

      - name: Upload net8.0-ios artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net8
          path: ./artifacts-net8/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-build-logs-net8
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET SDK 9+ for net9.0-ios and net10.0-ios support
  build-ios-net9plus:
    needs: build-xcframeworks
    name: net9.0-ios, net10.0-ios
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download XCFrameworks
        uses: actions/download-artifact@v7
        with:
          name: ios-xcframeworks
          path: src/iOS/Bindings/Libs

      - name: Verify XCFrameworks
        run: ls -la src/iOS/Bindings/Libs/

      - name: Remove global.json to allow SDK 9+
        run: rm -f global.json

      - name: Setup .NET SDK 9 and 10
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-9
        with:
          dotnet-version: |
            9.0.x
            10.0.x

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/Library/Caches/NuGet
          key: ${{ runner.os }}-dotnet-workload-ios-${{ steps.setup-dotnet-9.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-ios-

      - name: Install .NET MAUI iOS workload for SDK 9+
        run: dotnet workload install ios

      - name: Get dd-sdk-ios commit hash for cache
        id: sdk-version-net9plus
        run: echo "commit=$(git -C dd-sdk-ios rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Cache NuGet packages (net9.0-ios, net10.0-ios)
        id: cache-nuget-net9plus
        uses: actions/cache@v5
        with:
          path: ./artifacts-net9plus/*.nupkg
          key: ${{ runner.os }}-ios-net9plus-packages-${{ steps.sdk-version-net9plus.outputs.commit }}-${{ hashFiles('src/iOS/Bindings/**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-ios-net9plus-packages-${{ steps.sdk-version-net9plus.outputs.commit }}-

      - name: Restore dependencies (SDK 9+)
        if: steps.cache-nuget-net9plus.outputs.cache-hit != 'true'
        run: dotnet restore src/iOS/iOSDatadogBindings.sln

      - name: Build iOS bindings (net9.0-ios, net10.0-ios)
        if: steps.cache-nuget-net9plus.outputs.cache-hit != 'true'
        run: dotnet build src/iOS/iOSDatadogBindings.sln --configuration Release --no-restore

      - name: Package NuGet packages (net9.0-ios, net10.0-ios)
        if: steps.cache-nuget-net9plus.outputs.cache-hit != 'true'
        run: dotnet pack src/iOS/iOSDatadogBindings.sln --configuration Release --no-build --output ./artifacts-net9plus

      - name: Upload net9.0-ios and net10.0-ios artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages-net9plus
          path: ./artifacts-net9plus/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: ios-build-logs-net9plus
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Combine the net8 and net9+ packages into unified NuGet packages
  combine-ios-packages:
    name: Bundle iOS NuGets
    runs-on: ubuntu-latest
    needs: [build-ios-net8, build-ios-net9plus]

    steps:
      - name: Download net8.0-ios packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net8
          path: ./artifacts-net8

      - name: Download net9.0-ios and net10.0-ios packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages-net9plus
          path: ./artifacts-net9plus

      - name: Combine packages for all target frameworks
        run: |
          mkdir -p ./artifacts-combined
          mkdir -p ./temp-extract

          # Process each package
          for net8_pkg in ./artifacts-net8/*.nupkg; do
            pkg_name=$(basename "$net8_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+\.nupkg$//')
            version=$(basename "$net8_pkg" | grep -oP '\d+\.\d+\.\d+(?=\.nupkg)')
            net9plus_pkg="./artifacts-net9plus/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            if [ -f "$net9plus_pkg" ]; then
              # Extract both packages
              unzip -q "$net8_pkg" -d "./temp-extract/net8"
              unzip -q "$net9plus_pkg" -d "./temp-extract/net9plus"

              # Copy net9.0-ios and net10.0-ios libs to net8 package structure
              if [ -d "./temp-extract/net9plus/lib/net9.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net9.0-ios" "./temp-extract/net8/lib/"
              fi
              if [ -d "./temp-extract/net9plus/lib/net10.0-ios" ]; then
                cp -r "./temp-extract/net9plus/lib/net10.0-ios" "./temp-extract/net8/lib/"
              fi

              # Repackage the combined content
              cd "./temp-extract/net8"
              zip -q -r "../../artifacts-combined/${pkg_name}.${version}.nupkg" *
              cd ../..

              # Clean up temp directory
              rm -rf "./temp-extract/net8" "./temp-extract/net9plus"

              echo "Created combined package: ${pkg_name}.${version}.nupkg"
            else
              echo "Warning: No matching net9+ package found for $pkg_name"
              # Fall back to net8 package only
              cp "$net8_pkg" "./artifacts-combined/"
            fi
          done

      - name: List combined packages
        run: ls -lh ./artifacts-combined/

      - name: Package summary
        run: |
          echo "## iOS NuGet Packages Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target frameworks included:" >> $GITHUB_STEP_SUMMARY
          echo "- net8.0-ios" >> $GITHUB_STEP_SUMMARY
          echo "- net9.0-ios" >> $GITHUB_STEP_SUMMARY
          echo "- net10.0-ios" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All frameworks target iOS 17.0+ and are combined into single multi-framework packages." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -1 ./artifacts-combined/*.nupkg | xargs -n1 basename >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload combined NuGet packages
        uses: actions/upload-artifact@v6
        with:
          name: ios-nuget-packages
          path: ./artifacts-combined/*.nupkg
          retention-days: 7

  build-ios-test:
    name: Build iOS Test App
    runs-on: macos-15
    needs: combine-ios-packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install .NET MAUI workload
        run: |
          # Install iOS workload but skip manifest update to avoid pulling latest (26.2)
          dotnet workload install ios --skip-manifest-update

      - name: Download NuGet packages
        uses: actions/download-artifact@v7
        with:
          name: ios-nuget-packages
          path: ./artifacts

      - name: Get package version from artifacts
        id: package-version
        run: |
          # Extract version from first package filename (macOS compatible)
          PACKAGE=$(ls ./artifacts/*.nupkg | head -1 | xargs basename)
          VERSION=$(echo "$PACKAGE" | sed -E 's/.*\.([0-9]+\.[0-9]+\.[0-9]+)\.nupkg/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected package: $PACKAGE"
          echo "Extracted version: $VERSION"

      - name: Replace ProjectReferences with PackageReferences
        run: |
          # Replace ProjectReferences with PackageReferences using the built packages
          cat > src/iOS/T/T.csproj << 'EOF'
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>net10.0-ios</TargetFramework>
              <OutputType>Exe</OutputType>
              <Nullable>enable</Nullable>
              <ImplicitUsings>true</ImplicitUsings>
              <SupportedOSPlatformVersion>17.0</SupportedOSPlatformVersion>
              <ProvisioningType>manual</ProvisioningType>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Bcr.Datadog.iOS.Core" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.Logs" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.RUM" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.Trace" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.CR" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.SR" Version="${{ steps.package-version.outputs.version }}" />
              <PackageReference Include="Bcr.Datadog.iOS.Web" Version="${{ steps.package-version.outputs.version }}" />
            </ItemGroup>
          </Project>
          EOF

          echo "Updated T.csproj to use PackageReferences:"
          cat src/iOS/T/T.csproj

      - name: Add local NuGet source
        run: dotnet nuget add source $PWD/artifacts --name local

      - name: Restore test app dependencies
        run: dotnet restore src/iOS/T/Test.sln

      - name: Build test app
        run: dotnet build src/iOS/T/Test.sln --configuration Release --no-restore -p:BuildIpa=true -p:_ProvisioningProfile=manual

      - name: Upload test app
        uses: actions/upload-artifact@v6
        with:
          name: ios-test-app
          path: |
            src/iOS/T/bin/Release/**/*.app
            src/iOS/T/bin/Release/**/*.ipa
          retention-days: 7
