name: Build Android Bindings

on:
  workflow_call:  # Allow this workflow to be called by other workflows
  workflow_dispatch:  # Allow manual triggering

env:
  JAVA_VERSION: '17'

jobs:
  # Build with .NET SDK 9 for net9.0-android support
  build-android-net9:
    name: Build Android Bindings (net9.0-android)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup .NET SDK 9
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-9
        with:
          dotnet-version: 9.0.x

      - name: Create temporary global.json for SDK 9
        run: echo '{"sdk":{"version":"${{ steps.setup-dotnet-9.outputs.dotnet-version }}","rollForward":"latestPatch"}}' > ./global.json

      - name: Verify SDK version
        run: dotnet --version

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/.nuget/packages
          key: ${{ runner.os }}-dotnet-workload-android-${{ steps.setup-dotnet-9.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-android-

      - name: Install .NET Android workload for SDK 9
        run: dotnet workload install android

      - name: Build Android AAR files
        run: |
          chmod +x src/Android/build-aars.sh
          chmod +x src/Android/copy-aars.sh
          src/Android/build-aars.sh
          src/Android/copy-aars.sh

      - name: Restore dependencies (SDK 9)
        run: dotnet restore src/Android/AndroidDatadogBindings.sln

      - name: Build Android bindings (net9.0-android)
        run: dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore --verbosity minimal

      - name: Pack NuGet packages (net9.0-android)
        run: dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./artifacts-net9 2>&1 | grep -v "prerelease dependency" || true

      - name: Upload net9.0-android packages
        uses: actions/upload-artifact@v6
        with:
          name: android-nuget-packages-net9
          path: ./artifacts-net9/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: android-net9-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Build with .NET SDK 10+ for net10.0-android support
  build-android-net10:
    name: Build Android Bindings (net10.0-android)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Remove global.json to allow SDK 10+
        run: rm -f global.json

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        id: setup-dotnet-10
        with:
          dotnet-version: 10.0.x

      - name: Verify SDK version
        run: dotnet --version

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Cache .NET workloads
        uses: actions/cache@v5
        with:
          path: |
            ~/.dotnet/sdk-manifests
            ~/.dotnet/metadata
            ~/.dotnet/workloadsets
            ~/.nuget/packages
          key: ${{ runner.os }}-dotnet-workload-android-${{ steps.setup-dotnet-10.outputs.dotnet-version }}
          restore-keys: |
            ${{ runner.os }}-dotnet-workload-android-

      - name: Install .NET Android workload for SDK 10
        run: dotnet workload install android

      - name: Build Android AAR files
        run: |
          chmod +x src/Android/build-aars.sh
          chmod +x src/Android/copy-aars.sh
          src/Android/build-aars.sh
          src/Android/copy-aars.sh

      - name: Restore dependencies (SDK 10)
        run: dotnet restore src/Android/AndroidDatadogBindings.sln

      - name: Build Android bindings (net10.0-android)
        run: dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore --verbosity minimal

      - name: Pack NuGet packages (net10.0-android)
        run: dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./artifacts-net10 2>&1 | grep -v "prerelease dependency" || true

      - name: Upload net10.0-android packages
        uses: actions/upload-artifact@v6
        with:
          name: android-nuget-packages-net10
          path: ./artifacts-net10/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: android-net10-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  # Combine both target frameworks into unified packages
  combine-android-packages:
    needs: [build-android-net9, build-android-net10]
    name: Combine Android Packages
    runs-on: ubuntu-latest

    steps:
      - name: Download net9.0-android packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages-net9
          path: ./artifacts-net9

      - name: Download net10.0-android packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages-net10
          path: ./artifacts-net10

      - name: Combine packages for both target frameworks
        run: |
          mkdir -p ./artifacts-combined
          mkdir -p ./temp-extract

          # Process each package
          for net9_pkg in ./artifacts-net9/*.nupkg; do
            pkg_name=$(basename "$net9_pkg" | sed 's/\.[0-9]\+\.[0-9]\+\.[0-9]\+.*\.nupkg$//')
            version=$(basename "$net9_pkg" | sed -n 's/.*\.\([0-9]\+\.[0-9]\+\.[0-9]\+[^.]*\)\.nupkg$/\1/p')
            net10_pkg="./artifacts-net10/${pkg_name}.${version}.nupkg"

            echo "Processing $pkg_name version $version"

            if [ -f "$net10_pkg" ]; then
              # Extract both packages
              unzip -q "$net9_pkg" -d "./temp-extract/net9"
              unzip -q "$net10_pkg" -d "./temp-extract/net10"

              # Copy net10.0-android libs to net9 package structure
              if [ -d "./temp-extract/net10/lib/net10.0-android" ]; then
                cp -r "./temp-extract/net10/lib/net10.0-android" "./temp-extract/net9/lib/"
              fi

              # Repackage the combined content
              (cd "./temp-extract/net9" && zip -q -r "../../artifacts-combined/${pkg_name}.${version}.nupkg" *)

              # Clean up temp directories
              rm -rf "./temp-extract/net9" "./temp-extract/net10"

              echo "  ✅ Created combined package: ${pkg_name}.${version}.nupkg"
            else
              echo "  ⚠️  Missing net10 package, using net9 only"
              cp "$net9_pkg" "./artifacts-combined/"
            fi
          done

          echo ""
          echo "Combined packages:"
          ls -lh ./artifacts-combined/

      - name: Upload combined Android packages
        uses: actions/upload-artifact@v6
        with:
          name: android-nuget-packages-combined
          path: ./artifacts-combined/*.nupkg
          retention-days: 7

      - name: Package summary
        run: |
          echo "## Android NuGet Packages Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Target frameworks included:" >> $GITHUB_STEP_SUMMARY
          echo "- net9.0-android" >> $GITHUB_STEP_SUMMARY
          echo "- net10.0-android (⭐ Recommended - 16KB page size support)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Packages" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -1 ./artifacts-combined/*.nupkg | xargs -n1 basename >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  # Build Android test app using combined packages
  build-android-test:
    name: Build Android Test App
    runs-on: ubuntu-latest
    needs: combine-android-packages

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup .NET SDK 10
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Setup Java ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install .NET Android workload
        run: dotnet workload install android

      - name: Download combined packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages-combined
          path: ./artifacts

      - name: Add local NuGet source
        run: dotnet nuget add source ./artifacts --name local

      - name: Restore test app dependencies
        run: dotnet restore src/Android/Bindings/Test/TestBindings/TestBindings.csproj

      - name: Build test app
        run: dotnet build src/Android/Bindings/Test/TestBindings/TestBindings.csproj --configuration Release --no-restore

      - name: Upload test APK
        uses: actions/upload-artifact@v6
        with:
          name: android-test-apk
          path: src/Android/Bindings/Test/TestBindings/bin/Release/**/*.apk
          retention-days: 7
