name: Build Android Bindings

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/Android/**'
      - 'dd-sdk-android/**'
      - '.github/workflows/build-android.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/Android/**'
      - 'dd-sdk-android/**'
      - '.github/workflows/build-android.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '10.0.x'
  JAVA_VERSION: '17'

jobs:
  build-android:
    name: Build Android Bindings
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install .NET MAUI workload
        run: |
          dotnet workload install android

      - name: Restore dependencies
        run: dotnet restore src/Android/AndroidDatadogBindings.sln

      - name: Build Android bindings
        run: |
          # Build and suppress known binding warnings
          dotnet build src/Android/AndroidDatadogBindings.sln --configuration Release --no-restore --verbosity minimal

      - name: Package NuGet packages
        run: |
          # Suppress prerelease dependency warnings (expected for -pre.1 versions)
          dotnet pack src/Android/AndroidDatadogBindings.sln --configuration Release --no-build --output ./artifacts 2>&1 | grep -v "prerelease dependency" || true

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v6
        with:
          name: android-nuget-packages
          path: ./artifacts/*.nupkg
          retention-days: 7

      - name: Upload build logs on failure
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: android-build-logs
          path: |
            **/*.binlog
            **/bin/**/*.log
          if-no-files-found: ignore
          retention-days: 3

  build-android-test:
    name: Build Android Test App
    runs-on: ubuntu-latest
    needs: build-android

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: 'microsoft'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Install .NET MAUI workload
        run: |
          dotnet workload install android

      - name: Download NuGet packages
        uses: actions/download-artifact@v7
        with:
          name: android-nuget-packages
          path: ./artifacts

      - name: Add local NuGet source
        run: |
          dotnet nuget add source ./artifacts --name local

      - name: Restore test app dependencies
        run: dotnet restore src/Android/Bindings/Test/TestBindings/TestBindings.csproj

      - name: Build test app
        run: dotnet build src/Android/Bindings/Test/TestBindings/TestBindings.csproj --configuration Release --no-restore

      - name: Upload test APK
        uses: actions/upload-artifact@v6
        with:
          name: android-test-apk
          path: src/Android/Bindings/Test/TestBindings/bin/Release/**/*.apk
          retention-days: 7
